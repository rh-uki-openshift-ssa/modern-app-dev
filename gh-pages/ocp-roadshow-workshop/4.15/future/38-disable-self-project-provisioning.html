<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenShift Roadshow Workshop 2024</title>
    <link rel="canonical" href="http://localhost:3000/rhs-openshift-starter-guides/index.html/ocp-roadshow-workshop/4.15/future/38-disable-self-project-provisioning.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const clusterName = urlParams.get('CLUSTER_SUBDOMAIN');
      const projectName = urlParams.get('PROJECT');
      if (clusterName) {
        showCluster( clusterName );
      }
      else {
        showClusterForm();
      }

      if (projectName) {
        showProject( projectName );
      } else {
        showProjectForm();
      }
    } );


    function sliceCluster(clusterName){
      if (clusterName.length > 70) {
          return "..." + clusterName.slice(35);
      } else {
          return clusterName;
      }
    }

    function showCluster( clusterName ) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('cluster_subdomain').textContent = sliceCluster(clusterName);
      document.getElementById('clusterfield2').value = clusterName;

    }

    function showClusterForm( clusterName ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
    }

    function gowithcluster() {
      elClusterInput = document.getElementById('clusterfield');
      elProjectInput = document.getElementById('projectfield2');

      window.location.search = ('&CLUSTER_SUBDOMAIN=' + elClusterInput.value + '&PROJECT=' + elProjectInput.value);
    }

    function showProject( projectName ) {
      document.getElementById('navbar-form-project-empty').style.display = "none";
      document.getElementById('navbar-form-project-filled').style.display = "flex";
      document.getElementById('project').textContent = projectName;
      document.getElementById('projectfield2').value = projectName;
    }

    function showProjectForm( projectName ) {
      document.getElementById('navbar-form-project-empty').style.display = "flex";
      document.getElementById('navbar-form-project-filled').style.display = "none";
    }

    function gowithproject() {
      elProjectInput = document.getElementById('projectfield');
      elClusterInput = document.getElementById('clusterfield2');
      window.location.search = ('&CLUSTER_SUBDOMAIN=' + elClusterInput.value + '&PROJECT=' + elProjectInput.value);
    }

  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="http://localhost:3000/rhs-openshift-starter-guides/index.html">OpenShift Roadshow Workshop 2024</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item" id="navbar-form-empty">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>

          <form action="javascript:void(0);" onsubmit="gowithcluster();">
            <input size="40" id="clusterfield" type="text" placeholder="Enter Cluster Subdomain">
            <input type="hidden" id="projectfield2" name="projectfield2" value="">
          </form>
        </div>

        <div class="navbar-item" id="navbar-form-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
          <span class="navbar-text" id="cluster_subdomain"></span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
        </div>

         <div class="navbar-item" id="navbar-form-project-empty">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>

          <form action="javascript:void(0);" onsubmit="gowithproject();">
            <input size="40" id="projectfield" type="text" placeholder="Enter Project Name">
            <input type="hidden" id="clusterfield2" name="clusterfield2" value="">
          </form>
        </div>

        <div class="navbar-item" id="navbar-form-project-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
          <span class="navbar-text" id="project"></span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
        </div>
<!---
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
--->
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="ocp-roadshow-workshop" data-version="4.15">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">OCP Roadshow Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../xx-workshop-credentials-links.html">Credentials and links</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../01-modernisation-introduction.html">Application Migration &amp; Modernisation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../02-introduction.html"><strong>01</strong> - Migration Workshop Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../03-assessment.html"><strong>02</strong> - Migration Assessment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../04-analyze.html"><strong>03</strong> - Migration Analysis</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../10-security-infrastructure-introduction.html">Security &amp; Infrastructure</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../11-application-management-basics.html"><strong>04</strong> - Application Management Basics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../12-application-storage-basics.html"><strong>05</strong> - Application Storage Basics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../13-networking.html"><strong>06</strong> - Networking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../14-acs-vulnerability.html"><strong>07</strong> - ACS Vulnerability Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../15-acm.html"><strong>08</strong> - ACM multicluster Management</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCP Roadshow Workshop</span>
    <span class="version">4.15</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OCP Roadshow Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">4.15</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="file:///home/marrober/data/git-repos/rhuki-openshift-ssa/modern-app-dev/documentation/modules/ROOT/pages/future/38-disable-self-project-provisioning.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="paragraph">
<p>Disabling Project Self-Provisioning</p>
</div>
<div class="paragraph">
<p>Disabling Project Self-Provisioning
Before continuing, make sure you’ve done the LDAP lab.
OpenShift, by default, allows authenticated users to create Projects to logically house their applications. This feature enables admins to provide a "self service" feature that was popularized by the advent of the "PaaS" (Platform as a Service) model.</p>
</div>
<div class="paragraph">
<p>This feature may not be suitable for all situations, and many administrators may want to have more control over Projects and who (if anyone) can create them. Some of these use cases may be:</p>
</div>
<div class="paragraph">
<p>Environment Protection - Administrators may not want Projects getting created without their knowledge.</p>
</div>
<div class="paragraph">
<p>Resource Allocation - Administrator may want fine grained control over resource allocation (i.e. "I don’t want to overcommit")</p>
</div>
<div class="paragraph">
<p>Quota flexibility - Default quotas may be set, but Administrators may want to specify additional quotas (or fewer) depending on the Project scope.</p>
</div>
<div class="paragraph">
<p>Accounting and Chargeback - In a multitenant system, there may be a need to do accounting and chargeback.</p>
</div>
<div class="paragraph">
<p>General Administrative Control - Administrators may want total control in what goes in an environment.</p>
</div>
<div class="paragraph">
<p>There are other ways to gain this type of control besides disabling Project self-provisioning.
Background: Projects
What are you disabling exactly? In a previous lab, you learned that a Project is a "bucket" of sorts; which holds all the resources for an application. You also learned that Projects can be assigned to a user or group for collaboration. But what’s the difference between a Project and a Kubernetes Namespace?</p>
</div>
<div class="paragraph">
<p>A Project directly maps to a Kubernetes Namespace. It also maps to the internal registry’s namespace as well as to a VXLAN VNID. So giving access to a Project does more than let users collaborate. You are allowing network communications, registry namespace access, and access to objects within a Kubernetes Namespace.</p>
</div>
<div class="paragraph">
<p>Examine the Clusterrolebinding
In order to examine the clusterrolebinding for self-provisioners; you need to be kubeadmin.</p>
</div>
<div class="paragraph">
<p>You could also use the serviceaccount user that we’ve used in previous labs. Since kubeadmin and the service account user both have the cluster-admin role, it really doesn’t matter.
oc login -u kubeadmin -p 4nyNM-BZtvz-Btyng-dTexX
View the self-provisioners cluster role binding usage by running the oc describe command:</p>
</div>
<div class="paragraph">
<p>oc describe clusterrolebinding.rbac self-provisioners
You should see the following output:</p>
</div>
<div class="paragraph">
<p>Name:         self-provisioners
Labels:       &lt;none&gt;
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  self-provisioner
Subjects:
  Kind   Name                        Namespace
  ----   ----                        ---------
  Group  system:authenticated:oauth
Here, it’s saying that the group system:authenticated:oauth (which is a group that every user that has authenticated is a part of, by default), is bound to the self-provisioners role. This role is a built-in role in OpenShift that allows the users to create projects.</p>
</div>
<div class="paragraph">
<p>If you are interested in the different roles that come with OpenShift, you can learn more about them in the role-based access control (RBAC) documentation.
To view the configuration itself, inspect the yaml by running the following:</p>
</div>
<div class="paragraph">
<p>oc get clusterrolebinding.rbac self-provisioners -o yaml
The configuration should look something like this:</p>
</div>
<div class="paragraph">
<p>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2022-02-14T22:25:08Z"
  name: self-provisioners
  resourceVersion: "10620"
  uid: a0098c02-b9cb-4815-aebd-7dc44ef4d163
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: self-provisioner
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:authenticated:oauth
Removing Self Provisioning Projects
To remove the self-provisioner cluster role from the group system:authenticated:oauth you need to remove that group from the role binding.</p>
</div>
<div class="paragraph">
<p>oc patch clusterrolebinding.rbac self-provisioners -p '{"subjects": null}'
Automatic updates reset the cluster roles to a default state. In order to disable this, you need to set the annotation rbac.authorization.kubernetes.io/autoupdate to false by running:</p>
</div>
<div class="paragraph">
<p>oc patch clusterrolebinding.rbac self-provisioners -p '{ "metadata": { "annotations": { "rbac.authorization.kubernetes.io/autoupdate": "false" } } }'
View the new configuration:</p>
</div>
<div class="paragraph">
<p>oc get clusterrolebinding.rbac self-provisioners -o yaml
It should now have no subjects in the YAML. It should look something like this:</p>
</div>
<div class="paragraph">
<p>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "false"
  creationTimestamp: "2022-02-14T22:25:08Z"
  name: self-provisioners
  resourceVersion: "55489"
  uid: a0098c02-b9cb-4815-aebd-7dc44ef4d163
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: self-provisioner
Test this by logging in as fancyuser1 and try to create a project.</p>
</div>
<div class="paragraph">
<p>oc login -u fancyuser1 -p Op#nSh1ft
oc new-project fancyuserproject
You should see an error message:</p>
</div>
<div class="paragraph">
<p>Error from server (Forbidden): You may not request a new project via this API.
Login as the kubeadmin user for the next exercise.</p>
</div>
<div class="paragraph">
<p>oc login -u kubeadmin -p 4nyNM-BZtvz-Btyng-dTexX
Customizing the request message
Now any time a user tries to create a project they will be greeted with the same message You may not request a new project via this API. You can customize this message to give a more meaningful call to action.</p>
</div>
<div class="paragraph">
<p>For example, you can have the users submit a ticket requesting a project. We can do this by changing the text given, to include instructions:</p>
</div>
<div class="paragraph">
<p>oc patch --type=merge project.config.openshift.io cluster -p '{"spec":{"projectRequestMessage":"Please visit <a href="https://ticket.example.com" class="bare">https://ticket.example.com</a> to request a project"}}'
Here, you are adding the projectRequestMessage and the value Please visit <a href="https://ticket.example.com" class="bare">https://ticket.example.com</a> to request a project to the specification.</p>
</div>
<div class="paragraph">
<p>Before you can see this new message, you’ll need to wait for the apiserver application to rollout the changes. This can take some time to rollout, especially on a busy cluster.</p>
</div>
<div class="paragraph">
<p>sleep 30
oc rollout status -n  openshift-apiserver deploy/apiserver
Now, the user will get this message when trying to create a project. Test this by becoming the fancyuser1 user.</p>
</div>
<div class="paragraph">
<p>oc login -u fancyuser1 -p Op#nSh1ft
And try to create a project.</p>
</div>
<div class="paragraph">
<p>oc new-project fancyuserproject
You should see the following message:</p>
</div>
<div class="paragraph">
<p>Error from server (Forbidden): Please visit <a href="https://ticket.example.com" class="bare">https://ticket.example.com</a> to request a project
Clean Up
Make sure you login as kubeadmin for the next lab.</p>
</div>
<div class="paragraph">
<p>oc login -u kubeadmin -p 4nyNM-BZtvz-Btyng-dTexX
Other labs may require the self-provisioners role, so let’s undo what we did:</p>
</div>
<div class="paragraph">
<p>oc patch clusterrolebinding.rbac self-provisioners -p '{"subjects":[{"apiGroup":"rbac.authorization.k8s.io","kind":"Group","name":"system:authenticated:oauth"}]}'
oc patch clusterrolebinding.rbac self-provisioners -p '{"metadata":{"annotations":{"rbac.authorization.kubernetes.io/autoupdate":"true"}}}'
oc patch --type=json project.config.openshift.io cluster -p '[{"op": "remove", "path": "/spec/projectRequestMessage"}]'</p>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../../_/js/vendor/clipboard.js"></script>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
